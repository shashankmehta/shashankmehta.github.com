<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    Making Captain in Golang
  </title>
  <meta name="description" content="Personal website & blog of Shashank Mehta">
  <!-- Set theme immediately to prevent flash -->
  <script>
    // Immediately set the theme before any content renders
    (function() {
      const storedTheme = localStorage.getItem('theme');
      const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
      
      if (storedTheme === 'dark') {
        document.documentElement.dataset.theme = 'dark';
      } else if (storedTheme === 'light') {
        document.documentElement.dataset.theme = 'light';
      } else {
        // System preference
        document.documentElement.dataset.theme = prefersDarkScheme.matches ? 'dark' : 'light';
      }
    })();
  </script>
  <link rel="stylesheet" href="/css/main.css">
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Sometype+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  

  
    <meta property="og:title" content="Making Captain in Golang" />
    <meta name="twitter:title" content="Making Captain in Golang">
  

  

  <meta property="og:type" content="article" />
  <meta name="twitter:site" content="@shashankmehta05">
  <meta name="twitter:creator" content="@shashankmehta05">
  <meta name="twitter:url" content="https://shashankmehta.in/archive/2014/captain-in-golang.html">
</head>
<body>
  <div class="container">
    <header class="grid">
  <figure class="profile-image">
    <img src="/images/dp.jpeg" alt="Shashank Mehta">
  </figure>
  <div>
    <h1>
      Shashank Mehta
      <button id="theme-toggle" aria-label="Toggle dark/light mode" onclick="toggleTheme()">
  <svg class="light-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
  <svg class="dark-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
  <svg class="system-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
</button>

<script>
  // Helper function to update the button icon based on current theme
  function updateThemeIcon(theme) {
    const themeToggle = document.getElementById('theme-toggle');
    themeToggle.setAttribute('data-mode', theme);
  }

  // Initialize theme on page load
  document.addEventListener('DOMContentLoaded', function() {
    const html = document.documentElement;
    const savedTheme = localStorage.getItem('theme');
    
    if (savedTheme) {
      // If user has a saved preference, use it
      if (savedTheme !== 'system') {
        html.dataset.theme = savedTheme;
        updateThemeIcon(savedTheme);
      } else {
        // Using system preference
        updateThemeIcon('system');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        html.dataset.theme = prefersDark ? 'dark' : 'light';
      }
    } else {
      // Default to system
      // localStorage.setItem('theme', 'system');
      updateThemeIcon('system');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      html.dataset.theme = prefersDark ? 'dark' : 'light';
    }
  });

  // Toggle theme when button is clicked - cycle between light, dark, and system
  function toggleTheme() {
    const html = document.documentElement;

    // Determine current state. We persist it in localStorage (default = "system")
    const current = localStorage.getItem('theme') || 'system';
    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    // Compute next state based on current state and system preference
    let next;
    
    if (current === 'system') {
      // If in system mode, go to the opposite of what system currently shows
      next = systemPrefersDark ? 'light' : 'dark';
    } else if (current === 'dark') {
      next = 'light';
    } else { // current === 'light'
      next = 'system';
    }

    // Update button icon
    updateThemeIcon(next);

    // Apply the next state
    if (next === 'system') {
      // Follow OS preference â€“ remove manual override
      delete html.dataset.theme;
      // Apply current system preference
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      html.dataset.theme = prefersDark ? 'dark' : 'light';
    } else {
      html.dataset.theme = next;
    }

    // Persist the choice for future visits
    localStorage.setItem('theme', next);
  }
  
  // Listen for system preference changes
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
    if (!localStorage.getItem('theme') || localStorage.getItem('theme') === 'system') {
      document.documentElement.dataset.theme = event.matches ? 'dark' : 'light';
    }
  });
</script> 
    </h1>
    <nav>
      <ul>
        <li><a href="/">Home</a></li>
        
        
        <li><a href="https://x.com/shashankmehta05" target="_blank">X/Twitter</a></li>
        <li><a href="https://www.linkedin.com/in/mehta-shashank/" target="_blank">LinkedIn</a></li>
      </ul>
    </nav>
  </div>
  
</header>
<hr />


    <main>
      
<article>
  <nav>
    <a id="back-button" href="/blog" class="secondary">&larr; Back</a>
  </nav>

  

  <header>
    <h1>Making Captain in Golang</h1>
    <time datetime="2014-09-01">September  1, 2014</time>
  </header>

  <div>
    <p>I recently had an idea for a small project for <a href="http://github.com/sdslabs">SDSLabs</a> and Go seemed like the perfect choice for it.</p>
<p><strong>Problem</strong>: We have VMs through Xen Server for our applications. So when a developer needed to access the VMs, he'd use a password. Just typing this makes me cringe. This is highly insecure. We haven't had much problem with this setup but that doesn't make it less insecure.</p>
<p><strong>Solution</strong>: Use key based authorization. But manually managing this would be a headache. Hence, I wanted to create a tool that would help me and other admins in SDSLabs to manage permissions via keys. This still isn't super secure. A better way would be create a new user and handle file permissions via groups. We might go for that, maybe later.</p>
<p>The basic premise of the tool is that admins can run commands to add a person's public key to a deployment server's <code>.ssh/authorized_keys</code> file instead of having to manually do this. The tool, called captain, is tightly bound to our git server, Gitolite. Gitolite already has all our developer's public keys and it also has a list of admins. So we keep Gitolite as the <em>single source</em> of truth. Thanks to all of this, an admin only has to run <code>capt grant shashankmehta 218</code> to give <code>shashankmehta</code> access to <code>x.x.x.218</code> <em>(The first three parts are common for all our servers)</em>. Captain ensures that the person running the command is an admin, it picks up <code>shashankmehta</code>'s keys from Gitolite, sshs to <code>x.x.x.218</code> and adds the key to <code>.ssh/authorized_keys</code> if it isn't present already.</p>
<p>I'm using Go basically as an alternative to a bash script. Apart from the fact that string handling is much easier in Go when compared to Bash, the biggest advantage is thanks to Go routines.</p>
<p><img src="/images/posts/golang/gopher.jpg" alt="Gopher"></p>
<h2>What is a goroutine?</h2>
<p>If you want to directly jump to code, take a look at Go by examples' page on <a href="https://gobyexample.com/goroutines">goroutines</a>. Basically, goroutines are lightweight thread of execution. Translated to layman terms, goroutine allows you to run multiple functions concurrently. Go also provides <code>channels</code> to deal with goroutines. A practical example of where this is highly useful:</p>
<p>In Captain, there's a command <code>capt grant shashankmehta 218 210 212</code>. I'm trying to give a particular user access to multiple systems. In a naive implementation of this feature, the 3 systems would have been handled sequentially. With goroutines, all three are handled concurrently. The three instances of a single function output their results to a common channel which handles displaying the results to the user who ran the command. So now running granting access to 10 systems is nearly as fast as granting access to 1 system.</p>
<p>The ease of writing <code>goroutines</code> was the most impressive thing for me in Go.</p>
<h2>Getting Started With Go</h2>
<p>In case the above intrigued you enough to think about learning Go, here are a few pointers from my personal experience.</p>
<p>How did Go come about? Sorry, I'm not your history teacher. You'll have to hit Google/Wikipedia for that. I'll just say that as far as programming languages are concerned, Go is very new. Pssst, it's hip</p>
<p>The first thing that you will realize about Go is that when searching for something Go related on Google, you need to use Golang instead of Go.</p>
<p>The second thing that you'll want to do is go through the <a href="http://tour.golang.org/">Go Tour</a>. If you are like me, you'll be yawning after the first few chapters, not because Go is boring but because doing anything apart from writing code is boring. But my suggestion would be to finish at least till the slices chapter otherwise you are going to be googling every thing. Actually, you still will, but let's assume I didn't say that.</p>
<p>Done with Go Tour? So now you know that in the Go land, variable types come after variable name, unlike most of the programming languages that you must be familiar with. You know about functions and multiple returns etc. Just checking, don't get mad. Moving on...</p>
<p>If you stopped right at the slices chapter in Go tour, you'll have missed out on range operator. Go back and read about range. No, seriously. Inflict this upon yourself because this is something that you will come across a lot.</p>
<p>Now that you know about range, you will be using it in for loops a lot. One thing that stumped me initially was the fact that <code>if...else</code> has its own scope in Go. In a lot of languages, a variable defined inside the <code>if</code> scope is available outside it too, as long as you remain inside the parent function scope. This is not the case in Go. So you've got to define your variable before the <code>if...else</code> statement. Same thing for <code>for</code> loops. Get over it and enjoy the  language.</p>
<p>In case you are interested in reading the source of Captain, let me know and I'll post it. At SDSLabs, we try to open source most of our works but Captain is tightly bound to Gitolite.</p>

  </div>

  <footer>
    <hr />
    <!-- <div class="grid">
      <div class="col">
        <a href="http://twitter.com/share" class="twitter-share-button" data-count="none" data-via="">Tweet</a>
        <a href="http://twitter.com/" class="twitter-follow-button" data-show-count="false">Follow @</a>
        <script src="//platform.twitter.com/widgets.js" type="text/javascript"></script>
      </div>
    </div> -->
  </footer>
</article>

    </main>

    
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-32545112-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>

  </div>
</body>
</html> 